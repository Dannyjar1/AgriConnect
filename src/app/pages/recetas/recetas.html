<!-- AgriConnect Recetas - Diseño Moderno con TailwindCSS (reutilizando estilos del marketplace) -->
<div class="min-h-screen bg-gradient-agri font-noto-sans">
  
  <!-- Shared Header Component -->
  <app-shared-header currentPage="recetas"></app-shared-header>

  <!-- Main Content Area -->
  <main class="max-w-7xl mx-auto px-4 lg:px-6">
    
    <!-- Hero Search Section with Decorative Background -->
    <section class="py-16 lg:py-24 text-center relative overflow-hidden">
      <!-- Decorative background pattern for the hero section -->
      <div class="absolute inset-0 opacity-5">
        <img [src]="decorativeImage()" 
             alt="Decorative recipe pattern"
             class="w-full h-full object-cover object-center scale-110 transform rotate-3"
             loading="lazy">
      </div>
      
      <div class="max-w-4xl mx-auto relative z-10">
        <h1 class="text-4xl lg:text-6xl font-black text-gray-900 mb-6 font-epilogue leading-tight">
          <span class="text-gradient-agri">Descubre Recetas</span> Deliciosas
        </h1>
        <p class="text-xl lg:text-2xl text-gray-600 mb-12 max-w-3xl mx-auto leading-relaxed">
          Encuentra las mejores recetas y calcula automáticamente los ingredientes según las personas que vas a servir
        </p>
        
        <!-- Floating recipe elements for visual appeal -->
        <div class="absolute -top-4 -left-8 w-16 h-16 opacity-20 animate-bounce animation-delay-1000">
          <img [src]="decorativeImage()" 
               alt="Recipe decoration"
               class="w-full h-full object-cover rounded-full"
               loading="lazy">
        </div>
        <div class="absolute -top-8 -right-12 w-20 h-20 opacity-15 animate-bounce animation-delay-2000">
          <img [src]="decorativeImage()" 
               alt="Recipe decoration"
               class="w-full h-full object-cover rounded-full transform rotate-45"
               loading="lazy">
        </div>
        
        <!-- Enhanced Search Bar with Enter submission -->
        <div class="mb-8">
          <form [formGroup]="searchForm" (ngSubmit)="onSearchSubmit()" class="max-w-2xl mx-auto">
            <div class="relative">
              <span class="absolute left-6 top-1/2 transform -translate-y-1/2 text-gray-400 material-icons text-2xl">search</span>
              <input 
                type="text" 
                formControlName="searchTerm"
                placeholder="Busca recetas por nombre o ingredientes (ej: 'papa', 'tortilla')..."
                class="w-full pl-16 pr-6 py-6 text-lg border-2 border-gray-200 rounded-2xl focus:ring-4 focus:ring-agri-green-100 focus:border-agri-green-500 transition-all duration-300 bg-white shadow-lg"
                aria-label="Buscar recetas por nombre o ingredientes">
              
              <!-- Search button (visible on mobile) -->
              <button 
                type="submit"
                class="absolute right-4 top-1/2 transform -translate-y-1/2 bg-agri-green-600 hover:bg-agri-green-700 text-white w-12 h-12 rounded-xl transition-all hover:scale-105 md:hidden">
                <span class="material-icons">search</span>
              </button>
            </div>
            
            <!-- Hidden submit button for Enter key functionality -->
            <button type="submit" class="hidden" aria-hidden="true">Buscar</button>
          </form>
          
          <!-- Search suggestions -->
          <div class="max-w-2xl mx-auto mt-3">
            <p class="text-sm text-gray-500 text-center">
              <span class="font-medium">Prueba buscar:</span> 
              <button type="button" (click)="searchForm.patchValue({searchTerm: 'papa'})" class="text-agri-green-600 hover:text-agri-green-700 mx-1 underline">papa</button>, 
              <button type="button" (click)="searchForm.patchValue({searchTerm: 'tortilla'})" class="text-agri-green-600 hover:text-agri-green-700 mx-1 underline">tortilla</button>, 
              <button type="button" (click)="searchForm.patchValue({searchTerm: 'tomate'})" class="text-agri-green-600 hover:text-agri-green-700 mx-1 underline">tomate</button>
              <span class="ml-2 text-xs">• Presiona Enter para ir a resultados</span>
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Error Alert (No intrusivo) -->
    @if (error()) {
      <div class="max-w-4xl mx-auto mb-8">
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 flex items-center justify-between">
          <div class="flex items-center">
            <span class="material-icons text-red-500 mr-2">error</span>
            <span class="text-red-700">{{ error() }}</span>
          </div>
          <button 
            (click)="clearError()"
            class="text-red-500 hover:text-red-700 transition-colors">
            <span class="material-icons">close</span>
          </button>
        </div>
      </div>
    }

    <!-- Categories and Filters Quick Filter -->
    <section class="py-8">
      <div class="max-w-6xl mx-auto text-center">
        <!-- Categories -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold text-gray-700 mb-3">Categorías</h3>
          <div class="flex flex-wrap justify-center gap-3">
            @for (category of categories(); track category) {
              <button 
                type="button"
                (click)="onCategorySelect(category || '')"
                [class]="selectedCategory() === category ? 
                  'bg-agri-green-600 text-white border-agri-green-600' : 
                  'bg-white text-gray-600 border-gray-300 hover:border-agri-green-500 hover:text-agri-green-600 hover:bg-agri-green-50'"
                class="px-6 py-3 rounded-full border font-medium transition-all duration-200 font-epilogue">
                {{ category }}
              </button>
            }
          </div>
        </div>

        <!-- Difficulty Filter -->
        <div>
          <h3 class="text-lg font-semibold text-gray-700 mb-3">Dificultad</h3>
          <div class="flex flex-wrap justify-center gap-3">
            @for (difficulty of difficulties; track difficulty) {
              <button 
                type="button"
                (click)="onDifficultySelect(difficulty)"
                [class]="searchForm.get('difficulty')?.value === difficulty ? 
                  'bg-agri-green-600 text-white border-agri-green-600' : 
                  'bg-white text-gray-600 border-gray-300 hover:border-agri-green-500 hover:text-agri-green-600 hover:bg-agri-green-50'"
                class="px-4 py-2 rounded-full border font-medium transition-all duration-200 text-sm">
                {{ difficulty }}
              </button>
            }
          </div>
        </div>
      </div>
    </section>

    <!-- Recipes Grid Section -->
    <section class="py-12" id="recetas-disponibles">
      <div class="max-w-6xl mx-auto">
        <div class="text-center mb-16">
          <h2 class="text-4xl font-bold text-gray-900 mb-4 font-epilogue">
            Recetas Disponibles
            @if (hasActiveSearch()) {
              <span class="text-lg font-normal text-agri-green-600 block mt-2">
                ({{ getSearchResultsCount() }} {{ getSearchResultsCount() === 1 ? 'resultado' : 'resultados' }} {{ getSearchResultsCount() === 1 ? 'encontrado' : 'encontrados' }})
              </span>
            }
          </h2>
          <p class="text-xl text-gray-600 max-w-2xl mx-auto">
            @if (hasActiveSearch()) {
              Resultados de tu búsqueda. Selecciona una receta para ver los ingredientes escalados
            } @else {
              Selecciona una receta y personaliza las cantidades según el número de personas
            }
          </p>
          
          <!-- Active search indicator -->
          @if (hasActiveSearch()) {
            <div class="mt-6 flex flex-wrap justify-center gap-2">
              @if (searchForm.get('searchTerm')?.value) {
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-agri-green-100 text-agri-green-800">
                  <span class="material-icons text-sm mr-1">search</span>
                  "{{ searchForm.get('searchTerm')?.value }}"
                  <button type="button" (click)="searchForm.patchValue({searchTerm: ''})" class="ml-2 hover:text-agri-green-900">
                    <span class="material-icons text-sm">close</span>
                  </button>
                </span>
              }
              @if (searchForm.get('category')?.value && searchForm.get('category')?.value !== 'Todas') {
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                  <span class="material-icons text-sm mr-1">category</span>
                  {{ searchForm.get('category')?.value }}
                  <button type="button" (click)="searchForm.patchValue({category: 'Todas'})" class="ml-2 hover:text-blue-900">
                    <span class="material-icons text-sm">close</span>
                  </button>
                </span>
              }
              @if (searchForm.get('difficulty')?.value && searchForm.get('difficulty')?.value !== 'Todas') {
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-800">
                  <span class="material-icons text-sm mr-1">star</span>
                  {{ searchForm.get('difficulty')?.value }}
                  <button type="button" (click)="searchForm.patchValue({difficulty: 'Todas'})" class="ml-2 hover:text-purple-900">
                    <span class="material-icons text-sm">close</span>
                  </button>
                </span>
              }
              <button type="button" (click)="onClearFilters()" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors">
                <span class="material-icons text-sm mr-1">clear_all</span>
                Limpiar filtros
              </button>
            </div>
          }
        </div>
        
        @if (isLoading()) {
          <div class="text-center py-16">
            <div class="w-12 h-12 border-4 border-gray-200 border-t-agri-green-600 rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-xl text-gray-600">Cargando recetas deliciosas...</p>
          </div>
        }
        
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
          @if (filteredRecipes$ | async; as recipes) {
            @if (recipes.length > 0) {
              @for (recipe of recipes; track recipe.id) {
                <div class="card card-hover hover-lift group cursor-pointer" (click)="openRecipeDetail(recipe)">
                  <div class="relative aspect-w-4 aspect-h-3 overflow-hidden">
                    <img 
                      [src]="getRecipeImage(recipe)" 
                      [alt]="recipe.nombre" 
                      (error)="onImageError($event)"
                      class="w-full h-40 object-cover rounded-lg product-img">
                    <div class="absolute top-4 left-4">
                      @if (recipe.dificultad) {
                        <span [class]="getDifficultyColor(recipe.dificultad) + ' px-3 py-1 rounded-lg text-xs font-semibold uppercase tracking-wide'">
                          {{ recipe.dificultad }}
                        </span>
                      }
                    </div>
                    @if (recipe.tiempoPreparacion) {
                      <div class="absolute top-4 right-4">
                        <span class="bg-black bg-opacity-70 text-white px-3 py-1 rounded-lg text-xs font-medium flex items-center">
                          <span class="material-icons text-xs mr-1">schedule</span>
                          {{ getPreparationTimeText(recipe.tiempoPreparacion) }}
                        </span>
                      </div>
                    }
                  </div>
                  
                  <div class="p-6">
                    <h3 class="text-xl font-bold text-gray-900 mb-2 font-epilogue leading-tight">{{ recipe.nombre }}</h3>
                    @if (recipe.categoria) {
                      <p class="text-agri-green-600 text-sm font-medium mb-2">
                        <span class="material-icons text-xs mr-1">restaurant_menu</span>
                        {{ recipe.categoria }}
                      </p>
                    }
                    <p class="text-gray-600 mb-4 line-clamp-2">{{ recipe.descripcion || 'Deliciosa receta para disfrutar en familia' }}</p>
                    
                    <div class="flex justify-between items-center mb-6">
                      <span class="bg-gray-100 text-gray-600 px-3 py-1 rounded-lg text-sm font-medium">
                        {{ recipe.porciones_base }} {{ recipe.porciones_base === 1 ? 'porción' : 'porciones' }}
                      </span>
                      <span class="text-gray-500 text-sm">{{ recipe.ingredientes.length }} ingredientes</span>
                    </div>
                    
                    <div class="flex justify-center">
                      <button 
                        class="bg-agri-green-600 hover:bg-agri-green-700 text-white font-semibold px-6 py-3 rounded-lg transition-all hover:-translate-y-0.5 flex items-center space-x-2 group-hover:shadow-lg"
                        [attr.aria-label]="'Ver detalles de ' + recipe.nombre">
                        <span class="material-icons text-lg">visibility</span>
                        <span>Ver Receta</span>
                      </button>
                    </div>
                  </div>
                </div>
              }
            } @else {
              <div class="col-span-full text-center py-20">
                <div class="text-8xl mb-8 opacity-60">
                  @if (hasActiveSearch()) {
                    🔍
                  } @else {
                    🍳
                  }
                </div>
                <h3 class="text-2xl font-bold text-gray-700 mb-4 font-epilogue">
                  @if (hasActiveSearch()) {
                    No se encontraron recetas para tu búsqueda
                  } @else {
                    No hay recetas disponibles
                  }
                </h3>
                <p class="text-gray-600 mb-8 max-w-md mx-auto">
                  @if (hasActiveSearch()) {
                    @if (searchForm.get('searchTerm')?.value) {
                      No encontramos recetas que contengan "<strong>{{ searchForm.get('searchTerm')?.value }}</strong>". 
                      Prueba con términos como "papa", "tortilla", "tomate" o ajusta tus filtros.
                    } @else {
                      Prueba ajustando tus criterios de búsqueda o navega por nuestras categorías sugeridas
                    }
                  } @else {
                    Parece que aún no hay recetas cargadas en el sistema. Vuelve pronto para descubrir deliciosas recetas.
                  }
                </p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                  @if (hasActiveSearch()) {
                    <button (click)="onClearFilters()" class="btn-primary">
                      <span class="material-icons mr-2 text-sm">clear_all</span>
                      Ver Todas las Recetas
                    </button>
                    @if (searchForm.get('searchTerm')?.value) {
                      <button (click)="searchForm.patchValue({searchTerm: 'papa'})" class="btn-secondary">
                        <span class="material-icons mr-2 text-sm">search</span>
                        Buscar "papa"
                      </button>
                    }
                  } @else {
                    <button (click)="loadRecipes()" class="btn-primary">
                      <span class="material-icons mr-2 text-sm">refresh</span>
                      Recargar Recetas
                    </button>
                  }
                </div>
              </div>
            }
          }
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Recipe Detail Modal (reutilizando estilo de modal existente) -->
@if (showModal() && selectedRecipe() && scaledRecipe()) {
  <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" (click)="closeModal()">
    <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" (click)="$event.stopPropagation()">
      <!-- Modal Header -->
      <div class="sticky top-0 bg-white border-b border-gray-200 p-6 rounded-t-2xl">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-2xl font-bold text-gray-900 font-epilogue">{{ selectedRecipe()?.nombre }}</h2>
            @if (selectedRecipe()?.categoria) {
              <p class="text-agri-green-600 font-medium">{{ selectedRecipe()?.categoria }}</p>
            }
          </div>
          <button 
            (click)="closeModal()"
            class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-colors">
            <span class="material-icons text-gray-600">close</span>
          </button>
        </div>
      </div>

      <!-- Modal Content -->
      <div class="p-6">
        <!-- Recipe Info -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
          <div>
            <img 
              [src]="getRecipeImage(selectedRecipe()!)" 
              [alt]="selectedRecipe()?.nombre"
              (error)="onImageError($event)"
              class="w-full h-64 object-cover rounded-lg">
          </div>
          <div>
            @if (selectedRecipe()?.descripcion) {
              <p class="text-gray-600 mb-4">{{ selectedRecipe()?.descripcion }}</p>
            }
            
            <div class="grid grid-cols-2 gap-4 mb-6">
              @if (selectedRecipe()?.dificultad) {
                <div>
                  <span class="text-sm font-medium text-gray-500">Dificultad</span>
                  <p [class]="getDifficultyColor(selectedRecipe()?.dificultad) + ' inline-block px-3 py-1 rounded-lg text-sm font-semibold mt-1'">
                    {{ selectedRecipe()?.dificultad }}
                  </p>
                </div>
              }
              @if (selectedRecipe()?.tiempoPreparacion) {
                <div>
                  <span class="text-sm font-medium text-gray-500">Tiempo</span>
                  <p class="text-gray-900 font-semibold">{{ getPreparationTimeText(selectedRecipe()?.tiempoPreparacion) }}</p>
                </div>
              }
            </div>

            <!-- Portions Adjuster -->
            <div class="mb-6">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Porciones (Original: {{ selectedRecipe()?.porciones_base }})
              </label>
              <div class="flex items-center space-x-4">
                <button 
                  type="button"
                  (click)="updatePortions(selectedPortions() - 1)"
                  [disabled]="selectedPortions() <= 1"
                  class="w-10 h-10 rounded-full bg-agri-green-600 text-white hover:bg-agri-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-all">
                  <span class="material-icons">remove</span>
                </button>
                <span class="text-xl font-bold text-agri-green-600 min-w-[3rem] text-center">{{ selectedPortions() }}</span>
                <button 
                  type="button"
                  (click)="updatePortions(selectedPortions() + 1)"
                  [disabled]="selectedPortions() >= 50"
                  class="w-10 h-10 rounded-full bg-agri-green-600 text-white hover:bg-agri-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-all">
                  <span class="material-icons">add</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Ingredients List -->
        <div class="mb-8">
          <h3 class="text-xl font-bold text-gray-900 mb-4">Ingredientes ({{ selectedPortions() }} {{ selectedPortions() === 1 ? 'porción' : 'porciones' }})</h3>
          
          @if (ingredientsByCategory(); as categories) {
            @for (category of categories | keyvalue; track category.key) {
              <div class="mb-6">
                <h4 class="text-lg font-semibold text-agri-green-600 mb-3 flex items-center">
                  <span class="material-icons mr-2">category</span>
                  {{ category.key }}
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                  @for (ingredient of category.value; track ingredient.nombre) {
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                      <span class="font-medium text-gray-900">{{ ingredient.nombre }}</span>
                      <span class="text-agri-green-600 font-bold">
                        {{ formatQuantity(ingredient.cantidad_final) }} {{ ingredient.unidad }}
                      </span>
                    </div>
                  }
                </div>
              </div>
            }
          }
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
          <button 
            (click)="closeModal()"
            class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
            Cerrar
          </button>
          <button 
            (click)="addRecipeToCart()"
            class="px-6 py-3 bg-agri-green-600 hover:bg-agri-green-700 text-white rounded-lg transition-colors flex items-center space-x-2">
            <span class="material-icons">add_shopping_cart</span>
            <span>Agregar al Carrito</span>
          </button>
        </div>
      </div>
    </div>
  </div>
}