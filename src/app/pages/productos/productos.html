<!-- Header del componente -->
<div class="productos-header bg-gradient-to-r from-green-600 to-green-800 text-white py-8 px-4">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold mb-2">Cat√°logo de Productos</h1>
    <p class="text-green-100">Descubre productos frescos y locales organizados por categor√≠as</p>
    
    <!-- Estad√≠sticas r√°pidas -->
    <div class="flex flex-wrap gap-6 mt-6 text-sm">
      <div class="flex items-center gap-2">
        <span class="bg-white/20 px-2 py-1 rounded">üì¶</span>
        <span>{{ stats().totalProducts }} productos</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="bg-white/20 px-2 py-1 rounded">üè∑Ô∏è</span>
        <span>{{ stats().categoriesCount }} categor√≠as</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="bg-white/20 px-2 py-1 rounded">üí∞</span>
        <span>Precio promedio: ${{ stats().avgPrice }}</span>
      </div>
    </div>
  </div>
</div>

<!-- Filtros y controles -->
<div class="bg-white shadow-sm border-b py-4 px-4 sticky top-0 z-10">
  <div class="max-w-6xl mx-auto">
    <form [formGroup]="filterForm" class="space-y-4">
      
      <!-- Barra de b√∫squeda principal -->
      <div class="flex flex-col md:flex-row gap-4">
        <div class="flex-1">
          <input 
            type="text" 
            formControlName="searchTerm"
            placeholder="Buscar productos por nombre, categor√≠a o descripci√≥n..."
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
        </div>
        
        <!-- Controles de vista -->
        <div class="flex items-center gap-2">
          <button 
            type="button"
            (click)="onViewModeChange('grid')"
            [class.bg-green-500]="viewMode() === 'grid'"
            [class.text-white]="viewMode() === 'grid'"
            class="px-3 py-2 border rounded-lg hover:bg-gray-50 transition-colors">
            üî≤ Grid
          </button>
          <button 
            type="button"
            (click)="onViewModeChange('list')"
            [class.bg-green-500]="viewMode() === 'list'"
            [class.text-white]="viewMode() === 'list'"
            class="px-3 py-2 border rounded-lg hover:bg-gray-50 transition-colors">
            üìã Lista
          </button>
        </div>
      </div>

      <!-- Filtros avanzados -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        
        <!-- Selector de categor√≠a -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Categor√≠a</label>
          <select 
            formControlName="category"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-transparent">
            @for (category of categories(); track category) {
              <option [value]="category">{{ category }}</option>
            }
          </select>
        </div>

        <!-- Filtro de precio m√≠nimo -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Precio m√≠nimo</label>
          <input 
            type="number" 
            formControlName="minPrice"
            placeholder="$0.00"
            min="0"
            step="0.01"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-transparent">
        </div>

        <!-- Filtro de precio m√°ximo -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Precio m√°ximo</label>
          <input 
            type="number" 
            formControlName="maxPrice"
            placeholder="$999.99"
            min="0"
            step="0.01"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-transparent">
        </div>

        <!-- Filtro de certificaciones -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Certificaciones</label>
          <input 
            type="text" 
            formControlName="certifications"
            placeholder="Ej: Org√°nico, Comercio Justo"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-transparent">
        </div>
      </div>

      <!-- Bot√≥n para limpiar filtros -->
      <div class="flex justify-end">
        <button 
          type="button"
          (click)="onClearFilters()"
          class="px-4 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-md transition-colors">
          üîÑ Limpiar filtros
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Contenido principal -->
<div class="max-w-6xl mx-auto px-4 py-6">
  
  <!-- Indicador de carga -->
  @if (isLoading()) {
    <div class="flex justify-center items-center py-12">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500"></div>
      <span class="ml-3 text-gray-600">Cargando productos...</span>
    </div>
  } @else {
    
    <!-- Filtros de categor√≠as r√°pidos -->
    <div class="mb-6">
      <h3 class="text-lg font-semibold text-gray-800 mb-3">Categor√≠as</h3>
      <div class="flex flex-wrap gap-2">
        @for (category of categories(); track category) {
          <button
            (click)="onCategorySelect(category)"
            [class.bg-green-500]="selectedCategory() === category"
            [class.text-white]="selectedCategory() === category"
            [class.bg-gray-100]="selectedCategory() !== category"
            [class.text-gray-700]="selectedCategory() !== category"
            class="px-4 py-2 rounded-full text-sm font-medium hover:bg-green-600 hover:text-white transition-colors">
            {{ category }}
            @if (category !== 'Todas') {
              <span class="ml-1 text-xs opacity-75">
                ({{ productsByCategory().find(c => c.category === category)?.count || 0 }})
              </span>
            }
          </button>
        }
      </div>
    </div>

    <!-- Resultados -->
    @if (filteredProducts().length === 0) {
      <!-- Estado vac√≠o -->
      <div class="text-center py-12">
        <div class="text-6xl mb-4">üîç</div>
        <h3 class="text-xl font-semibold text-gray-600 mb-2">No se encontraron productos</h3>
        <p class="text-gray-500 mb-4">Intenta ajustar los filtros o busca con t√©rminos diferentes</p>
        <button 
          (click)="onClearFilters()"
          class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-colors">
          Mostrar todos los productos
        </button>
      </div>
    } @else {
      
      <!-- Mostrar productos organizados por categor√≠a cuando no hay filtro espec√≠fico -->
      @if (selectedCategory() === 'Todas' && !filterForm.get('searchTerm')?.value) {
        
        <!-- Vista por categor√≠as -->
        @for (categoryGroup of productsByCategory(); track trackByCategoryName($index, categoryGroup)) {
          <div class="mb-10">
            <h2 class="text-2xl font-bold text-gray-800 mb-1">{{ categoryGroup.category }}</h2>
            <p class="text-gray-600 mb-4">{{ categoryGroup.count }} productos disponibles</p>
            
            <!-- Grid de productos por categor√≠a -->
            <div [ngClass]="viewMode() === 'grid' 
              ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6'
              : 'space-y-4'">
              
              @for (product of categoryGroup.products; track trackByProductId($index, product)) {
                <!-- Tarjeta de producto -->
                <div 
                  (click)="onProductClick(product.id)"
                  class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer overflow-hidden"
                  [ngClass]="viewMode() === 'list' ? 'flex' : 'block'">
                  
                  <!-- Imagen del producto -->
                  <div [ngClass]="viewMode() === 'list' ? 'w-32 h-32 flex-shrink-0' : 'w-full h-48'">
                    @if (product.images && product.images.length > 0) {
                      <img 
                        [src]="product.images[0]" 
                        [alt]="product.name"
                        class="w-full h-full object-cover">
                    } @else {
                      <div class="w-full h-full bg-gray-200 flex items-center justify-center text-4xl">
                        üçÉ
                      </div>
                    }
                  </div>
                  
                  <!-- Contenido de la tarjeta -->
                  <div class="p-4 flex-1">
                    <h3 class="font-semibold text-gray-800 mb-2 truncate">{{ product.name }}</h3>
                    <p class="text-gray-600 text-sm mb-3 line-clamp-2">{{ product.description }}</p>
                    
                    <!-- Precio y disponibilidad -->
                    <div class="flex justify-between items-center mb-3">
                      <span class="text-lg font-bold text-green-600">
                        ${{ product.price.perUnit }} / {{ product.price.unit }}
                      </span>
                      <span class="text-sm text-gray-500">
                        {{ product.availability }} disponibles
                      </span>
                    </div>
                    
                    <!-- Certificaciones -->
                    @if (product.certifications.length > 0) {
                      <div class="flex flex-wrap gap-1 mb-3">
                        @for (cert of product.certifications; track cert) {
                          <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">
                            {{ cert }}
                          </span>
                        }
                      </div>
                    }
                    
                    <!-- Botones de acci√≥n -->
                    <div class="flex gap-2">
                      <button 
                        (click)="onAddToCart(product); $event.stopPropagation()"
                        class="flex-1 bg-green-500 text-white px-3 py-2 rounded-md hover:bg-green-600 transition-colors text-sm">
                        üõí Agregar
                      </button>
                      @if (product.producerId) {
                        <button 
                          (click)="onProducerClick(product.producerId); $event.stopPropagation()"
                          class="px-3 py-2 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors text-sm">
                          üë®‚Äçüåæ
                        </button>
                      }
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>
        }
        
      } @else {
        
        <!-- Vista de productos filtrados (sin agrupaci√≥n por categor√≠a) -->
        <div class="mb-4">
          <h2 class="text-xl font-semibold text-gray-800">
            Resultados 
            @if (selectedCategory() !== 'Todas') {
              <span class="text-green-600">en {{ selectedCategory() }}</span>
            }
            ({{ filteredProducts().length }} productos)
          </h2>
        </div>
        
        <!-- Grid de productos filtrados -->
        <div [ngClass]="viewMode() === 'grid' 
          ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6'
          : 'space-y-4'">
          
          @for (product of filteredProducts(); track trackByProductId($index, product)) {
            <!-- Tarjeta de producto (igual que arriba) -->
            <div 
              (click)="onProductClick(product.id)"
              class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer overflow-hidden"
              [ngClass]="viewMode() === 'list' ? 'flex' : 'block'">
              
              <!-- Imagen del producto -->
              <div [ngClass]="viewMode() === 'list' ? 'w-32 h-32 flex-shrink-0' : 'w-full h-48'">
                @if (product.images && product.images.length > 0) {
                  <img 
                    [src]="product.images[0]" 
                    [alt]="product.name"
                    class="w-full h-full object-cover">
                } @else {
                  <div class="w-full h-full bg-gray-200 flex items-center justify-center text-4xl">
                    üçÉ
                  </div>
                }
              </div>
              
              <!-- Contenido de la tarjeta -->
              <div class="p-4 flex-1">
                <div class="flex justify-between items-start mb-2">
                  <h3 class="font-semibold text-gray-800 truncate flex-1">{{ product.name }}</h3>
                  <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full ml-2">
                    {{ product.category }}
                  </span>
                </div>
                
                <p class="text-gray-600 text-sm mb-3 line-clamp-2">{{ product.description }}</p>
                
                <!-- Precio y disponibilidad -->
                <div class="flex justify-between items-center mb-3">
                  <span class="text-lg font-bold text-green-600">
                    ${{ product.price.perUnit }} / {{ product.price.unit }}
                  </span>
                  <span class="text-sm text-gray-500">
                    {{ product.availability }} disponibles
                  </span>
                </div>
                
                <!-- Certificaciones -->
                @if (product.certifications.length > 0) {
                  <div class="flex flex-wrap gap-1 mb-3">
                    @for (cert of product.certifications; track cert) {
                      <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">
                        {{ cert }}
                      </span>
                    }
                  </div>
                }
                
                <!-- Botones de acci√≥n -->
                <div class="flex gap-2">
                  <button 
                    (click)="onAddToCart(product); $event.stopPropagation()"
                    class="flex-1 bg-green-500 text-white px-3 py-2 rounded-md hover:bg-green-600 transition-colors text-sm">
                    üõí Agregar
                  </button>
                  @if (product.producerId) {
                    <button 
                      (click)="onProducerClick(product.producerId); $event.stopPropagation()"
                      class="px-3 py-2 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors text-sm">
                      üë®‚Äçüåæ
                    </button>
                  }
                </div>
              </div>
            </div>
          }
        </div>
      }
    }
  }
</div>